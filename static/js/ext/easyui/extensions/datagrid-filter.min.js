!function(t){var e=t.fn.datagrid.methods.autoSizeColumn,i=t.fn.datagrid.methods.loadData,r=t.fn.datagrid.methods.appendRow,a=t.fn.datagrid.methods.deleteRow;t.extend(t.fn.datagrid.methods,{autoSizeColumn:function(i,r){return i.each(function(){var i=t(this).datagrid("getPanel").find(".datagrid-header .datagrid-filter-c");i.css({width:"1px",height:0}),e.call(t.fn.datagrid.methods,t(this),r),i.css({width:"",height:""}),o(this,r)})},loadData:function(e,r){return e.each(function(){t.data(this,"datagrid").filterSource=null}),i.call(t.fn.datagrid.methods,e,r)},appendRow:function(e,i){var a=r.call(t.fn.datagrid.methods,e,i);return e.each(function(){var e=t(this).data("datagrid");e.filterSource&&(e.filterSource.total++,e.filterSource.rows!=e.data.rows&&e.filterSource.rows.push(i))}),a},deleteRow:function(e,i){return e.each(function(){var e=t(this).data("datagrid"),r=e.options;if(e.filterSource&&r.idField)if(e.filterSource.rows==e.data.rows)e.filterSource.total--;else for(var a=0;a<e.filterSource.rows.length;a++){if(e.filterSource.rows[a][r.idField]==e.data.rows[i][r.idField]){e.filterSource.rows.splice(a,1),e.filterSource.total--;break}}}),a.call(t.fn.datagrid.methods,e,i)}});var n={filterMenuIconCls:"icon-ok",filterBtnIconCls:"icon-filter",filterBtnPosition:"right",filterPosition:"bottom",remoteFilter:!1,clientPaging:!0,showFilterBar:!0,filterDelay:400,filterRules:[],filterMatchingType:"all",filterIncludingChild:!1,filterMatcher:function(e){var i=t(this),r=t.data(this,"datagrid").options;if(r.filterRules.length){for(var a=[],o=0;o<e.rows.length;o++){var l=e.rows[o];d(l,o)&&a.push(l)}e={total:e.total-(e.rows.length-a.length),rows:a}}return e;function d(e,a){r.val==t.fn.combogrid.defaults.val&&(r.val=n.val);var o=r.filterRules;if(!o.length)return!0;for(var l=0;l<o.length;l++){var d=o[l],f=i.datagrid("getColumnOption",d.field),s=f&&f.formatter?f.formatter(e[d.field],e,a):void 0,u=r.val.call(i[0],e,d.field,s);null==u&&(u="");var c=r.operators[d.op].isMatch(u,d.value);if("any"==r.filterMatchingType){if(c)return!0}else if(!c)return!1}return"all"==r.filterMatchingType}},defaultFilterType:"text",defaultFilterOperator:"contains",defaultFilterOptions:{onInit:function(e){var i="datagrid",r=t(e)[i]("options"),a=this.filterOptions,n=t(this).attr("name"),o=t(this);function l(){var l=t(e)[i]("getFilterRule",n),d=o.val();if(""!=d){if(l&&l.value!=d||!l){var f=l?l.op:a&&a.defaultFilterOperator||r.defaultFilterOperator;t(e)[i]("addFilterRule",{field:n,op:f,value:d}),t(e)[i]("doFilter")}}else l&&(t(e)[i]("removeFilterRule",n),t(e)[i]("doFilter"))}o.data("textbox")&&(o=o.textbox("textbox")),o.unbind(".filter").bind("keydown.filter",function(e){t(this);this.timer&&clearTimeout(this.timer),13==e.keyCode?l():r.filterDelay&&(this.timer=setTimeout(function(){l()},r.filterDelay))})}},filterStringify:function(t){return JSON.stringify(t)},val:function(t,e,i){return i||t[e]},onClickMenu:function(t,e){}};function o(e,i){var r=!1,a=t(e),n=a.datagrid("getPanel").find("div.datagrid-header"),o=n.find(".datagrid-header-row:not(.datagrid-filter-row)");(i?n.find('.datagrid-filter[name="'+i+'"]'):n.find(".datagrid-filter")).each(function(){var e=t(this).attr("name"),i=a.datagrid("getColumnOption",e),n=t(this).closest("div.datagrid-filter-c"),l=n.find("a.datagrid-filter-btn"),d=o.find('td[field="'+e+'"] .datagrid-cell')._outerWidth();d!=function(e){var i=0;return t(e).children(":visible").each(function(){i+=t(this)._outerWidth()}),i}(n)&&this.filter.resize(this,d-l._outerWidth()),n.width()>i.boxWidth+i.deltaWidth-1&&(i.boxWidth=n.width()-i.deltaWidth+1,i.width=i.boxWidth+i.deltaWidth,r=!0)}),r&&t(e).datagrid("fixColumnSize")}function l(e,i){return t(e).datagrid("getPanel").find("div.datagrid-header").find('tr.datagrid-filter-row td[field="'+i+'"] .datagrid-filter')}function d(e,i){for(var r=t(e).datagrid("options").filterRules,a=0;a<r.length;a++)if(r[a].field==i)return a;return-1}function f(e,i){var r=t(e).datagrid("options"),a=r.filterRules;if("nofilter"==i.op)s(e,i.field);else{var n=d(e,i.field);n>=0?t.extend(a[n],i):a.push(i)}var o=l(e,i.field);if(o.length){if("nofilter"!=i.op){var f=o.val();o.data("textbox")&&(f=o.textbox("getText")),f!=i.value&&o[0].filter.setValue(o,i.value)}var u=o[0].menu;if(u){u.find("."+r.filterMenuIconCls).removeClass(r.filterMenuIconCls);var c=u.menu("findItem",r.operators[i.op].text);u.menu("setIcon",{target:c.target,iconCls:r.filterMenuIconCls})}}}function s(e,i){var r=t(e),a=r.datagrid("options");if(i){var n=d(e,i);n>=0&&a.filterRules.splice(n,1),o([i])}else{a.filterRules=[],o(r.datagrid("getColumnFields",!0).concat(r.datagrid("getColumnFields")))}function o(t){for(var i=0;i<t.length;i++){var r=l(e,t[i]);if(r.length){r[0].filter.setValue(r,"");var n=r[0].menu;n&&n.find("."+a.filterMenuIconCls).removeClass(a.filterMenuIconCls)}}}}function u(e){var i="datagrid",r=t.data(e,i),a=r.options;a.remoteFilter?t(e)[i]("load"):("scrollview"==a.view.type&&r.data.firstRows&&r.data.firstRows.length&&(r.data.rows=r.data.firstRows),t(e)[i]("getPager").pagination("refresh",{pageNumber:1}),t(e)[i]("options").pageNumber=1,t(e)[i]("loadData",r.filterSource||r.data))}function c(e,i){i=i||[];var r="datagrid",a=t.data(e,r),n=a.options;n.filterRules.length||(n.filterRules=[]),n.filterCache=n.filterCache||{};var l=t.data(e,"datagrid").options,d=l.onResize;l.onResize=function(t,i){o(e),d.call(this,t,i)};var s=l.onBeforeSortColumn;l.onBeforeSortColumn=function(t,e){var i=s.call(this,t,e);return 0!=i&&(n.isSorting=!0),i};var c=n.onResizeColumn;n.onResizeColumn=function(i,r){var a=t(this).datagrid("getPanel").find(".datagrid-header .datagrid-filter-c"),l=a.find(".datagrid-filter:focus");a.css({width:"1px",height:0}),t(e).datagrid("fitColumns"),n.fitColumns?o(e):o(e,i),a.css({width:"",height:""}),l.blur().focus(),c.call(e,i,r)};var h=n.onBeforeLoad;function g(i){var l=a.dc,d=t(e).datagrid("getColumnFields",i);i&&n.rownumbers&&d.unshift("_");var f=(i?l.header1:l.header2).find("table.datagrid-htable");f.find(".datagrid-filter").each(function(){this.filter.destroy&&this.filter.destroy(this),this.menu&&t(this.menu).menu("destroy")}),f.find("tr.datagrid-filter-row").remove();var s=t('<tr class="datagrid-header-row datagrid-filter-row"></tr>');"bottom"==n.filterPosition?s.appendTo(f.find("tbody")):s.prependTo(f.find("tbody")),n.showFilterBar||s.hide();for(var u=0;u<d.length;u++){var c=d[u],h=t(e).datagrid("getColumnOption",c),g=t("<td></td>").attr("field",c).appendTo(s);if(h&&h.hidden&&g.hide(),"_"!=c&&(!h||!h.checkbox&&!h.expander)){var m=v(c);m?t(e)[r]("destroyFilter",c):m=t.extend({},{field:c,type:n.defaultFilterType,options:n.defaultFilterOptions});var w=n.filterCache[c];if(w)w.appendTo(g);else{w=t('<div class="datagrid-filter-c"></div>').appendTo(g);var b=n.filters[m.type],x=b.init(w,t.extend({height:n.editorHeight},m.options||{}));x.addClass("datagrid-filter").attr("name",c),x[0].filter=b,x[0].filterOptions=m,x[0].menu=p(w,m.op),m.op&&m.op.length?m.options&&m.options.onInit?m.options.onInit.call(x[0],e):m.defaultFilterOperator&&n.defaultFilterOptions.onInit.call(x[0],e):n.defaultFilterOptions.onInit.call(x[0],e),n.filterCache[c]=w,o(e,c)}}}}function p(i,r){if(!r)return null;var a=t('<a class="datagrid-filter-btn">&nbsp;</a>').addClass(n.filterBtnIconCls);a.css("height",n.editorHeight),"right"==n.filterBtnPosition?a.appendTo(i):a.prependTo(i);var o=t("<div></div>").appendTo("body");return t.map(["nofilter"].concat(r),function(e){var i=n.operators[e];i&&t("<div></div>").attr("name",e).html(i.text).appendTo(o)}),o.menu({alignTo:a,onClick:function(i){var r=t(this).menu("options").alignTo,a=r.closest("td[field]"),o=a.attr("field"),l=a.find(".datagrid-filter"),d=l[0].filter.getValue(l);0!=n.onClickMenu.call(e,i,r,o)&&(f(e,{field:o,op:i.name,value:d}),u(e))}}),a[0].menu=o,a.bind("click",{menu:o},function(e){return t(this.menu).menu("show"),!1}),o}function v(t){for(var e=0;e<i.length;e++){var r=i[e];if(r.field==t)return r}return null}n.onBeforeLoad=function(t,e){t&&(t.filterRules=n.filterStringify(n.filterRules)),e&&(e.filterRules=n.filterStringify(n.filterRules));var i=h.call(this,t,e);return 0!=i&&n.url&&(a.filterSource=null),i},n.loadFilter=function(e,i){var r=n.oldLoadFilter.call(this,e,i);return function(e,i){var r="datagrid",a=t.data(this,r),n=a.options;if(t.isArray(e)&&(e={total:e.length,rows:e}),!n.remoteFilter||n.clientPaging){if(a.filterSource&&n.isSorting?n.isSorting=void 0:a.filterSource=e,!n.remoteSort&&n.sortName){var o=n.sortName.split(","),l=n.sortOrder.split(","),d=t(this);a.filterSource.rows.sort(function(t,e){for(var i=0,r=0;r<o.length;r++){var a=o[r],n=l[r];if(0!=(i=(d.datagrid("getColumnOption",a).sorter||function(t,e){return t==e?0:t>e?1:-1})(t[a],e[a])*("asc"==n?1:-1)))return i}return i})}e=n.filterMatcher.call(this,{total:a.filterSource.total,rows:a.filterSource.rows,footer:a.filterSource.footer||[]})}if(n.pagination&&n.clientPaging){var f=(d=t(this))[r]("getPager");f.pagination({onSelectPage:function(t,e){n.pageNumber=t,n.pageSize=e,f.pagination("refresh",{pageNumber:t,pageSize:e}),n.clientPaging?d[r]("loadData",a.filterSource):d[r]("reload")},onBeforeRefresh:function(){return d[r]("reload"),!1}});var s=u(e.rows);n.pageNumber=s.pageNumber,e.rows=s.rows}return t.map(e.rows,function(t){t.children=void 0}),e;function u(t){for(var e=[],i=n.pageNumber;i>0;){var r=(i-1)*parseInt(n.pageSize),a=r+parseInt(n.pageSize);if((e=t.slice(r,a)).length)break;i--}return{pageNumber:i>0?i:1,rows:e}}}.call(this,r,i)},a.dc.view2.children(".datagrid-header").unbind(".filter").bind("focusin.filter",function(e){var i=t(this);setTimeout(function(){a.dc.body2._scrollLeft(i._scrollLeft())},0)}),t("#datagrid-filter-style").length||t("head").append('<style id="datagrid-filter-style">a.datagrid-filter-btn{display:inline-block;width:22px;height:100%;margin:0;vertical-align:middle;cursor:pointer;opacity:0.6;filter:alpha(opacity=60);}a:hover.datagrid-filter-btn{opacity:1;filter:alpha(opacity=100);}.datagrid-filter-row .textbox,.datagrid-filter-row .textbox .textbox-text{-moz-border-radius:0;-webkit-border-radius:0;border-radius:0;}.datagrid-filter-row input{margin:0;-moz-border-radius:0;-webkit-border-radius:0;border-radius:0;}.datagrid-filter-c{overflow:hidden}.datagrid-filter-cache{position:absolute;width:10px;height:10px;left:-99999px;}</style>'),g(!0),g(),n.fitColumns&&setTimeout(function(){o(e)},0),t.map(n.filterRules,function(t){f(e,t)})}t.extend(t.fn.datagrid.defaults,n),t.fn.datagrid.defaults.filters=t.extend({},t.fn.datagrid.defaults.editors,{label:{init:function(e,i){return t("<span></span>").appendTo(e)},getValue:function(e){return t(e).html()},setValue:function(e,i){t(e).html(i)},resize:function(e,i){t(e)._outerWidth(i)._outerHeight(22)}}}),t.fn.datagrid.defaults.operators={nofilter:{text:"No Filter"},contains:{text:"Contains",isMatch:function(t,e){return t=String(t),e=String(e),t.toLowerCase().indexOf(e.toLowerCase())>=0}},equal:{text:"Equal",isMatch:function(t,e){return t==e}},notequal:{text:"Not Equal",isMatch:function(t,e){return t!=e}},beginwith:{text:"Begin With",isMatch:function(t,e){return t=String(t),e=String(e),0==t.toLowerCase().indexOf(e.toLowerCase())}},endwith:{text:"End With",isMatch:function(t,e){return t=String(t),e=String(e),-1!==t.toLowerCase().indexOf(e.toLowerCase(),t.length-e.length)}},less:{text:"Less",isMatch:function(t,e){return t<e}},lessorequal:{text:"Less Or Equal",isMatch:function(t,e){return t<=e}},greater:{text:"Greater",isMatch:function(t,e){return t>e}},greaterorequal:{text:"Greater Or Equal",isMatch:function(t,e){return t>=e}}},t.extend(t.fn.datagrid.methods,{isFilterEnabled:function(e){var i=(e[0],"datagrid");return!!t.data(e[0],i).options.oldLoadFilter},enableFilter:function(e,i){return e.each(function(){var e="datagrid",r=t.data(this,e).options;if(r.oldLoadFilter){if(!i)return;t(this)[e]("disableFilter")}r.oldLoadFilter=r.loadFilter,c(this,i),t(this)[e]("resize"),r.filterRules.length&&(r.remoteFilter?u(this):r.data&&u(this))})},disableFilter:function(e){return e.each(function(){var e="datagrid",i=t.data(this,e),r=i.options;if(r.oldLoadFilter){var a=t(this).data("datagrid").dc,n=a.view.children(".datagrid-filter-cache");for(var o in n.length||(n=t('<div class="datagrid-filter-cache"></div>').appendTo(a.view)),r.filterCache)t(r.filterCache[o]).appendTo(n);var l=i.data;i.filterSource&&(l=i.filterSource,t.map(l.rows,function(t){t.children=void 0})),a.header1.add(a.header2).find("tr.datagrid-filter-row").remove(),r.loadFilter=r.oldLoadFilter||void 0,r.oldLoadFilter=null,t(this)[e]("resize"),t(this)[e]("loadData",l)}})},destroyFilter:function(e,i){return e.each(function(){var e="datagrid",r=t.data(this,e).options;if(i)n(i);else{for(var a in r.filterCache)n(a);t(this).datagrid("getPanel").find(".datagrid-header .datagrid-filter-row").remove(),t(this).data("datagrid").dc.view.children(".datagrid-filter-cache").remove(),r.filterCache={},t(this)[e]("resize"),t(this)[e]("disableFilter")}function n(e){var i=t(r.filterCache[e]),a=i.find(".datagrid-filter");if(a.length){var n=a[0].filter;n.destroy&&n.destroy(a[0])}i.find(".datagrid-filter-btn").each(function(){t(this.menu).menu("destroy")}),i.remove(),r.filterCache[e]=void 0}})},getFilterRule:function(e,i){return function(e,i){var r=t(e).datagrid("options").filterRules,a=d(e,i);return a>=0?r[a]:null}(e[0],i)},addFilterRule:function(t,e){return t.each(function(){f(this,e)})},removeFilterRule:function(t,e){return t.each(function(){s(this,e)})},doFilter:function(t){return t.each(function(){u(this)})},getFilterComponent:function(t,e){return l(t[0],e)},resizeFilter:function(t,e){return t.each(function(){o(this,e)})}})}(jQuery);